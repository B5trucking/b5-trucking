
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>B5 Trucking - Driver Portal</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --brand-primary: #dc2626;
      --brand-light: #fee2e2;
      --brand-gradient: linear-gradient(135deg, #fca5a5 0%, #dc2626 100%);
      --bg-main: #f5f7fb;
      --bg-surface: #ffffff;
      --text-primary: #111827;
      --text-muted: #6b7280;
      --border: #e5e7eb;
      --gradient-red: linear-gradient(135deg, #fecaca 0%, #dc2626 100%);
      --gradient-blue: linear-gradient(135deg, #bfdbfe 0%, #3b82f6 100%);
      --gradient-green: linear-gradient(135deg, #a7f3d0 0%, #10b981 100%);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    body {
      background: var(--bg-main);
      min-height: 100vh;
      color: var(--text-primary);
    }

    /* LOGIN SCREEN */
    .login-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .login-container {
      background: var(--bg-surface);
      border-radius: 20px;
      padding: 48px 40px;
      max-width: 440px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.08);
      border: 1px solid var(--border);
      text-align: center;
    }

    .login-logo {
      width: 72px;
      height: 72px;
      margin: 0 auto 20px;
      background: var(--brand-gradient);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 32px;
      font-weight: 700;
    }

    .login-container h1 {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
      letter-spacing: -0.02em;
    }

    .login-container .subtitle {
      color: var(--text-muted);
      font-size: 15px;
      margin-bottom: 32px;
    }

    .code-input {
      width: 180px;
      height: 72px;
      font-size: 36px;
      text-align: center;
      border-radius: 16px;
      border: 2px solid var(--border);
      margin: 0 auto 24px;
      letter-spacing: 0.3em;
      font-weight: 600;
      background: #fafafa;
      transition: all 0.2s;
    }

    .code-input:focus {
      outline: none;
      border-color: var(--brand-primary);
      box-shadow: 0 0 0 4px rgba(220, 38, 38, 0.1);
      background: white;
    }

    .btn {
      width: 100%;
      padding: 16px 24px;
      border-radius: 12px;
      border: none;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--brand-primary);
      color: white;
      box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
    }

    .btn-primary:hover {
      background: #b91c1c;
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(220, 38, 38, 0.4);
    }

    .error-msg {
      background: #fee2e2;
      color: #991b1b;
      padding: 12px;
      border-radius: 10px;
      margin-top: 16px;
      display: none;
      font-size: 14px;
      border: 1px solid #fecaca;
    }

    .admin-link {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid var(--border);
    }

    .admin-link a {
      color: var(--text-muted);
      text-decoration: none;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .admin-link a:hover {
      color: var(--brand-primary);
      gap: 6px;
    }

    /* MAIN APP */
    .app-container {
      display: none;
      min-height: 100vh;
    }

    .app-container.active {
      display: block;
    }

    .app-header {
      background: var(--bg-surface);
      border-bottom: 1px solid var(--border);
      padding: 20px 24px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .app-logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      background: var(--brand-gradient);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 18px;
    }

    .logo-text {
      font-size: 18px;
      font-weight: 700;
    }

    .driver-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .driver-badge {
      background: var(--brand-light);
      border: 1px solid #fecaca;
      color: #991b1b;
      padding: 8px 16px;
      border-radius: 999px;
      font-size: 14px;
      font-weight: 600;
    }

    .logout-btn {
      padding: 8px 16px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: white;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .logout-btn:hover {
      background: #f9fafb;
    }

    .main-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 32px 24px;
    }

    .page-title {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
      letter-spacing: -0.02em;
    }

    .page-subtitle {
      color: var(--text-muted);
      font-size: 15px;
      margin-bottom: 28px;
    }

    /* STATS GRID */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: var(--bg-surface);
      border-radius: 16px;
      padding: 24px;
      position: relative;
      overflow: hidden;
      border: 1px solid var(--border);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
    }

    .stat-card::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      opacity: 0.08;
      border-radius: 16px;
    }

    .stat-card.gradient-1::before {
      background: var(--gradient-red);
    }

    .stat-card.gradient-2::before {
      background: var(--gradient-blue);
    }

    .stat-card.gradient-3::before {
      background: var(--gradient-green);
    }

    .stat-content {
      position: relative;
      z-index: 1;
    }

    .stat-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      letter-spacing: -0.02em;
    }

    .stat-detail {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* FORM CARD */
    .form-card {
      background: var(--bg-surface);
      border-radius: 16px;
      padding: 28px;
      border: 1px solid var(--border);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
      margin-bottom: 24px;
    }

    .card-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-title::before {
      content: "";
      width: 4px;
      height: 20px;
      background: var(--brand-primary);
      border-radius: 999px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .form-input,
    .form-select,
    .form-textarea {
      padding: 12px 14px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 15px;
      background: #fafafa;
      transition: all 0.2s;
      font-family: inherit;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--brand-primary);
      background: white;
      box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
    }

    .form-input[readonly] {
      background: #f3f4f6;
      color: var(--text-muted);
      cursor: not-allowed;
    }

    .form-textarea {
      min-height: 80px;
      resize: vertical;
    }

    .form-helper {
      font-size: 12px;
      color: var(--text-muted);
    }

    .file-input-wrapper {
      position: relative;
    }

    .file-input {
      padding: 12px 14px;
      border: 2px dashed var(--border);
      border-radius: 10px;
      background: #fafafa;
      cursor: pointer;
      transition: all 0.2s;
    }

    .file-input:hover {
      border-color: var(--brand-primary);
      background: #fff;
    }

    .success-msg {
      background: #d1fae5;
      border: 1px solid #a7f3d0;
      color: #065f46;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 20px;
      display: none;
      font-weight: 500;
      align-items: center;
      gap: 8px;
    }

    .success-msg.show {
      display: flex;
    }

    /* TICKETS TABLE */
    .tickets-table {
      background: var(--bg-surface);
      border-radius: 16px;
      border: 1px solid var(--border);
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
    }

    .table-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .table-title {
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .table-title::before {
      content: "";
      width: 4px;
      height: 20px;
      background: var(--brand-primary);
      border-radius: 999px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: #fafafa;
    }

    th {
      padding: 14px 24px;
      text-align: left;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    td {
      padding: 16px 24px;
      font-size: 14px;
      border-top: 1px solid #f3f4f6;
    }

    tbody tr:hover {
      background: #fafafa;
    }

    .badge {
      display: inline-flex;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 500;
    }

    .badge.success {
      background: #d1fae5;
      color: #065f46;
    }

    .badge.bonus {
      background: #fef3c7;
      color: #92400e;
    }

    /* SUMMARY BOX */
    .summary-box {
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      margin-top: 24px;
    }

    .summary-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 16px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      font-size: 15px;
      border-bottom: 1px solid #f3f4f6;
    }

    .summary-row:last-child {
      border-bottom: none;
    }

    .summary-row.total {
      border-top: 2px solid var(--brand-primary);
      padding-top: 16px;
      margin-top: 8px;
      font-size: 18px;
      font-weight: 700;
      color: var(--brand-primary);
    }

    .hidden {
      display: none;
    }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      .main-content {
        padding: 24px 16px;
      }

      .header-content {
        padding: 0;
      }

      .driver-info {
        flex-direction: column;
        align-items: flex-end;
        gap: 8px;
      }

      .driver-badge {
        font-size: 13px;
        padding: 6px 12px;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .page-title {
        font-size: 24px;
      }

      .stat-value {
        font-size: 28px;
      }

      .login-container {
        padding: 32px 24px;
      }

      .code-input {
        width: 160px;
        height: 64px;
        font-size: 32px;
      }

      /* Table scrolling on mobile */
      .tickets-table {
        overflow-x: auto;
      }

      table {
        min-width: 600px;
      }

      th, td {
        padding: 12px 16px;
        font-size: 13px;
        white-space: nowrap;
      }

      /* Make all buttons thumb-friendly (44px minimum) */
      .btn {
        min-height: 48px;
        padding: 14px 24px;
        font-size: 16px;
      }

      .logout-btn {
        min-height: 40px;
        padding: 10px 14px;
      }

      /* Form inputs - prevent iOS zoom */
      .form-input,
      .form-select,
      .form-textarea {
        font-size: 16px;
        min-height: 48px;
      }

      .form-textarea {
        min-height: 100px;
      }

      /* Better spacing on mobile */
      .form-card {
        padding: 20px;
      }

      .card-title {
        font-size: 16px;
      }

      .summary-box {
        padding: 20px;
      }
    }

    /* Extra small phones */
    @media (max-width: 400px) {
      .app-header {
        padding: 16px;
      }

      .main-content {
        padding: 20px 12px;
      }

      .login-container {
        padding: 28px 20px;
      }

      .login-container h1 {
        font-size: 24px;
      }

      .code-input {
        width: 140px;
        height: 60px;
        font-size: 28px;
      }

      .stat-value {
        font-size: 24px;
      }
    }
  </style>
</head>
<body>
  <!-- LOGIN SCREEN -->
  <div id="loginScreen" class="login-screen">
    <div class="login-container">
      <div class="login-logo">B5</div>
      <h1>Driver Portal</h1>
      <p class="subtitle">Enter your 2-digit code to access ticket entry</p>
      
      <input 
        type="text" 
        id="driverCode" 
        class="code-input" 
        maxlength="2" 
        placeholder="00"
        inputmode="numeric"
        pattern="[0-9]*"
      />
      
      <button class="btn btn-primary" onclick="submitCode()">Sign In</button>
      
      <div id="errorMsg" class="error-msg">
        ⚠️ Invalid code. Please try again.
      </div>

      <div class="admin-link">
        <a href="admin-portal.html">Admin Login →</a>
      </div>
    </div>
  </div>

  <!-- MAIN APP -->
  <div id="appContainer" class="app-container">
    <!-- HEADER -->
    <header class="app-header">
      <div class="header-content">
        <div class="app-logo">
          <div class="logo-icon">B5</div>
          <div class="logo-text">B5 Trucking</div>
        </div>
        <div class="driver-info">
          <div class="driver-badge" id="driverBadge">Driver</div>
          <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
      </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="main-content">
      <h1 class="page-title">Driver Ticket Entry</h1>
      <p class="page-subtitle">Submit your load tickets and track weekly earnings</p>

      <!-- STATS GRID -->
      <div class="stats-grid">
        <div class="stat-card gradient-1">
          <div class="stat-content">
            <div class="stat-label">This Week's Loads</div>
            <div class="stat-value" id="weekLoadsCount">0</div>
            <div class="stat-detail">Total tickets submitted</div>
          </div>
        </div>

        <div class="stat-card gradient-2">
          <div class="stat-content">
            <div class="stat-label">Weekly Earnings</div>
            <div class="stat-value" id="weekEarnings">$0</div>
            <div class="stat-detail">Load pay + bonuses</div>
          </div>
        </div>

        <div class="stat-card gradient-3">
          <div class="stat-content">
            <div class="stat-label">Bonus Pay</div>
            <div class="stat-value" id="bonusEarnings">$0</div>
            <div class="stat-detail">3rd load bonuses</div>
          </div>
        </div>
      </div>

      <!-- NAME INPUT FOR "OTHER" DRIVERS -->
      <div id="otherNameSection" class="form-card hidden">
        <h2 class="card-title">Enter Your Information</h2>
        <div class="form-group">
          <label class="form-label">Full Name (First Last)</label>
          <input type="text" class="form-input" id="otherDriverName" placeholder="Enter your full name">
        </div>
      </div>

      <!-- TICKET ENTRY FORM -->
      <div class="form-card">
        <h2 class="card-title">New Ticket Entry</h2>

        <div id="successMsg" class="success-msg">
          <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
          Ticket submitted successfully!
        </div>

        <input type="hidden" id="driverName" />

        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Truck Number</label>
            <select class="form-select" id="truckNumber">
              <option value="">Select Truck</option>
              <option value="Truck 1">Truck 1</option>
              <option value="Truck 2">Truck 2</option>
              <option value="Truck 3">Truck 3</option>
              <option value="Truck 4">Truck 4</option>
              <option value="Truck 5">Truck 5</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Ticket Number</label>
            <input type="text" class="form-input" id="ticketNumber" placeholder="Enter ticket #">
          </div>

          <div class="form-group">
            <label class="form-label">Date</label>
            <input type="date" class="form-input" id="ticketDate">
          </div>

          <div class="form-group">
            <label class="form-label">3rd Load Today?</label>
            <select class="form-select" id="thirdLoad">
              <option value="No">No</option>
              <option value="Yes">Yes ($10 bonus)</option>
            </select>
          </div>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Gross Weight (lbs)</label>
            <input type="text" class="form-input" id="grossWeight" placeholder="Enter lbs" oninput="formatNumberWithCommas(this)" inputmode="numeric">
          </div>

          <div class="form-group">
            <label class="form-label">Tare Weight (lbs)</label>
            <input type="text" class="form-input" id="tareWeight" placeholder="Enter lbs" oninput="formatNumberWithCommas(this)" inputmode="numeric">
          </div>

          <div class="form-group">
            <label class="form-label">Net Weight (tons)</label>
            <input type="text" class="form-input" id="netTons" readonly placeholder="Auto-calculated">
          </div>
        </div>

        <div class="form-group" style="margin-bottom: 20px;">
          <label class="form-label">Route / Notes (Optional)</label>
          <textarea class="form-textarea" id="routeNotes" placeholder="Any notes about this load..."></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">Ticket Photo</label>
          <input type="file" class="file-input" id="ticketPhoto" accept="image/*" capture="environment">
          <span class="form-helper">Required: Take a clear photo of the ticket</span>
        </div>

        <button class="btn btn-primary" onclick="submitTicket()" style="margin-top: 24px;">
          Submit Ticket
        </button>
      </div>

      <!-- SUBMITTED TICKETS -->
      <div id="submittedSection" class="hidden">
        <div class="tickets-table">
          <div class="table-header">
            <h2 class="table-title">Submitted Tickets This Week</h2>
          </div>

          <div style="overflow-x: auto;">
            <table>
              <thead>
                <tr>
                  <th>#</th>
                  <th>Date</th>
                  <th>Ticket #</th>
                  <th>Net Tons</th>
                  <th>3rd Load</th>
                  <th style="text-align: right;">Pay</th>
                </tr>
              </thead>
              <tbody id="ticketBody"></tbody>
            </table>
          </div>

          <div class="summary-box">
            <div class="summary-title">Weekly Summary</div>
            <div class="summary-row">
              <span>Total Loads:</span>
              <span id="totalLoads">0</span>
            </div>
            <div class="summary-row">
              <span>Load Pay ($130/load):</span>
              <span id="loadPay">$0.00</span>
            </div>
            <div class="summary-row">
              <span>Bonus Pay:</span>
              <span id="bonusPay">$0.00</span>
            </div>
            <div class="summary-row total">
              <span>Total Earnings:</span>
              <span id="totalPay">$0.00</span>
            </div>
          </div>
        </div>
      </div>

      <!-- ALL MY TICKETS (EXPANDABLE) -->
      <div class="form-card" style="margin-top: 24px;">
        <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleAllTickets()">
          <h2 class="card-title" style="margin: 0;">All My Tickets</h2>
          <button class="btn btn-secondary" style="padding: 8px 16px;" id="toggleTicketsBtn">
            Show All
          </button>
        </div>

        <div id="allTicketsSection" style="display: none; margin-top: 20px;">
          <!-- Filters -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;">
            <div class="form-group">
              <label class="form-label">Year</label>
              <select class="form-select" id="filterTicketYear" onchange="filterAllTickets()">
                <option value="all">All Years</option>
                <option value="2025">2025</option>
                <option value="2024">2024</option>
                <option value="2023">2023</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">Month</label>
              <select class="form-select" id="filterTicketMonth" onchange="filterAllTickets()">
                <option value="all">All Months</option>
                <option value="1">January</option>
                <option value="2">February</option>
                <option value="3">March</option>
                <option value="4">April</option>
                <option value="5">May</option>
                <option value="6">June</option>
                <option value="7">July</option>
                <option value="8">August</option>
                <option value="9">September</option>
                <option value="10">October</option>
                <option value="11">November</option>
                <option value="12">December</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">Truck</label>
              <select class="form-select" id="filterTicketTruck" onchange="filterAllTickets()">
                <option value="all">All Trucks</option>
                <option value="Truck 1">Truck 1</option>
                <option value="Truck 2">Truck 2</option>
                <option value="Truck 3">Truck 3</option>
                <option value="Truck 4">Truck 4</option>
                <option value="Truck 5">Truck 5</option>
              </select>
            </div>
          </div>

          <!-- Tickets Table -->
          <div style="overflow-x: auto; background: white; border-radius: 12px; border: 1px solid var(--border);">
            <table>
              <thead style="background: #fafafa;">
                <tr>
                  <th style="padding: 14px; text-align: left; font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase;">Date</th>
                  <th style="padding: 14px; text-align: left; font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase;">Ticket #</th>
                  <th style="padding: 14px; text-align: left; font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase;">Truck</th>
                  <th style="padding: 14px; text-align: left; font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase;">Gross (lbs)</th>
                  <th style="padding: 14px; text-align: left; font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase;">Tare (lbs)</th>
                  <th style="padding: 14px; text-align: left; font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase;">Net Tons</th>
                  <th style="padding: 14px; text-align: left; font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase;">3rd Load</th>
                  <th style="padding: 14px; text-align: right; font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase;">Pay</th>
                </tr>
              </thead>
              <tbody id="allTicketsBody">
                <tr>
                  <td colspan="8" style="text-align: center; padding: 40px; color: var(--text-muted);">No tickets found</td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Totals -->
          <div class="summary-box" style="margin-top: 20px;">
            <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f3f4f6;">
              <span>Total Tickets:</span>
              <span id="allTicketsCount" style="font-weight: 600;">0</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f3f4f6;">
              <span>Total Loads Pay:</span>
              <span id="allTicketsLoadPay" style="font-weight: 600;">$0.00</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f3f4f6;">
              <span>Total Bonus Pay:</span>
              <span id="allTicketsBonusPay" style="font-weight: 600;">$0.00</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 16px 0 0 0; font-size: 18px; font-weight: 700; color: var(--brand-primary);">
              <span>Total Earnings:</span>
              <span id="allTicketsTotal">$0.00</span>
            </div>
          </div>
        </div>
      </div>

      <!-- REVENUE ANALYTICS CHART -->
      <div class="form-card" style="margin-top: 24px;">
        <h2 class="card-title">Earnings Chart</h2>

        <!-- Chart Filters -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
          <div class="form-group">
            <label class="form-label">Year</label>
            <select class="form-select" id="driverChartYear" onchange="updateDriverChart()">
              <option value="2025">2025</option>
              <option value="2024">2024</option>
              <option value="2023">2023</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">View</label>
            <select class="form-select" id="driverChartView" onchange="handleDriverViewChange()">
              <option value="monthly">Monthly (Full Year)</option>
              <option value="weekly">Weekly (Last 8 Weeks)</option>
              <option value="quarter">Quarterly</option>
            </select>
          </div>

          <div class="form-group" id="driverMonthFilter" style="display: none;">
            <label class="form-label">Month</label>
            <select class="form-select" id="driverChartMonth" onchange="updateDriverChart()">
              <option value="all">All Months</option>
              <option value="1">January</option>
              <option value="2">February</option>
              <option value="3">March</option>
              <option value="4">April</option>
              <option value="5">May</option>
              <option value="6">June</option>
              <option value="7">July</option>
              <option value="8">August</option>
              <option value="9">September</option>
              <option value="10">October</option>
              <option value="11">November</option>
              <option value="12">December</option>
            </select>
          </div>
        </div>

        <!-- Chart Canvas -->
        <div style="background: white; padding: 24px; border-radius: 12px; border: 1px solid var(--border);">
          <canvas id="driverEarningsChart" style="max-height: 350px;"></canvas>
        </div>

        <!-- Chart Summary Stats -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-top: 20px;">
          <div style="background: #fafafa; padding: 16px; border-radius: 10px; text-align: center;">
            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Total Earnings</div>
            <div style="font-size: 20px; font-weight: 700; color: var(--brand-primary);" id="driverTotalEarnings">$0</div>
          </div>
          <div style="background: #fafafa; padding: 16px; border-radius: 10px; text-align: center;">
            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Total Loads</div>
            <div style="font-size: 20px; font-weight: 700;" id="driverTotalLoads">0</div>
          </div>
          <div style="background: #fafafa; padding: 16px; border-radius: 10px; text-align: center;">
            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Avg Per Load</div>
            <div style="font-size: 20px; font-weight: 700;" id="driverAvgPerLoad">$0</div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // Initialize Supabase
    const SUPABASE_URL = 'https://jnytbgbevfyfqpjsdwiv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpueXRiZ2JldmZ5ZnFwanNkd2l2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY2ODQ5NzAsImV4cCI6MjA4MjI2MDk3MH0.3MNnntapdLT7TLAjwftHVQQ8Wir75OlAQ8wteifhiUM';
    
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentDriver = null;
    let weeklyTickets = [];

    async function submitCode() {
      const code = document.getElementById('driverCode').value.trim();
      
      if (!code) {
        showError('Please enter a driver code');
        return;
      }

      try {
        // Check if driver exists in database
        const { data: driver, error } = await supabaseClient
          .from('drivers')
          .select('*')
          .eq('driver_code', code)
          .eq('status', 'active')
          .single();

        if (error || !driver) {
          showError('Invalid code or driver is inactive');
          return;
        }

        // Valid driver - show main app
        currentDriver = driver;
        document.getElementById('driverName').value = driver.name;
        document.getElementById('driverBadge').textContent = driver.name;

        // Save session to localStorage
        localStorage.setItem('b5_driver_session', JSON.stringify({
          driver: driver,
          loginTime: new Date().toISOString()
        }));

        // Show name input for "Other" drivers (code 00)
        if (code === '00') {
          document.getElementById('otherNameSection').classList.remove('hidden');
        }

        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('appContainer').classList.add('active');

        // Set today's date
        document.getElementById('ticketDate').valueAsDate = new Date();

        // Load weekly tickets
        await loadWeeklyTickets();

        // Load all tickets for chart
        await loadAllDriverTickets();

      } catch (err) {
        console.error('Login error:', err);
        showError('Connection error. Please try again.');
      }
    }

    function showError(message) {
      const errorMsg = document.getElementById('errorMsg');
      errorMsg.textContent = '⚠️ ' + message;
      errorMsg.style.display = 'block';
      setTimeout(() => {
        errorMsg.style.display = 'none';
      }, 3000);
    }

    async function loadWeeklyTickets() {
      try {
        // Get start of current week (Monday)
        const now = new Date();
        const dayOfWeek = now.getDay();
        const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
        const monday = new Date(now);
        monday.setDate(now.getDate() + daysToMonday);
        monday.setHours(0, 0, 0, 0);

        // Get tickets for this driver from this week
        const { data: tickets, error } = await supabaseClient
          .from('tickets')
          .select('*')
          .eq('driver_id', currentDriver.id)
          .gte('ticket_date', monday.toISOString().split('T')[0])
          .order('created_at', { ascending: false });

        if (error) {
          console.error('Error loading tickets:', error);
          return;
        }

        weeklyTickets = tickets || [];
        
        if (weeklyTickets.length > 0) {
          updateTicketDisplay();
          updateStats();
        }

      } catch (err) {
        console.error('Error loading tickets:', err);
      }
    }

    function formatNumberWithCommas(input) {
      let value = input.value.replace(/,/g, '');
      
      if (value && !isNaN(value)) {
        value = parseFloat(value).toLocaleString('en-US');
        input.value = value;
      }
      
      calculateNetTons();
    }

    function calculateNetTons() {
      const grossInput = document.getElementById('grossWeight');
      const tareInput = document.getElementById('tareWeight');
      
      const gross = parseFloat(grossInput.value.replace(/,/g, '')) || 0;
      const tare = parseFloat(tareInput.value.replace(/,/g, '')) || 0;
      const netTons = (gross - tare) / 2000;
      
      if (gross > 0 && tare > 0) {
        document.getElementById('netTons').value = netTons.toFixed(2) + ' tons';
      } else {
        document.getElementById('netTons').value = '';
      }
    }

    async function submitTicket() {
      const truckNumber = document.getElementById('truckNumber').value;
      const ticketNumber = document.getElementById('ticketNumber').value;
      const ticketDate = document.getElementById('ticketDate').value;
      const grossWeight = document.getElementById('grossWeight').value.replace(/,/g, '');
      const tareWeight = document.getElementById('tareWeight').value.replace(/,/g, '');
      const routeNotes = document.getElementById('routeNotes').value;
      const thirdLoad = document.getElementById('thirdLoad').value === 'Yes';
      const photoFile = document.getElementById('ticketPhoto').files[0];

      // Get actual driver name for "Other"
      let actualDriverName = currentDriver.name;
      if (currentDriver.driver_code === '00') {
        actualDriverName = document.getElementById('otherDriverName').value.trim();
        if (!actualDriverName) {
          alert('Please enter your full name');
          return;
        }
      }

      if (!truckNumber || !ticketNumber || !ticketDate || !grossWeight || !tareWeight) {
        alert('Please fill in all required fields');
        return;
      }

      if (!photoFile) {
        alert('Please upload a photo of the ticket');
        return;
      }

      // Disable submit button
      const submitBtn = event.target;
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';

      try {
        // Calculate values
        const netTons = (parseFloat(grossWeight) - parseFloat(tareWeight)) / 2000;
        const bonusPay = thirdLoad ? 10 : 0;
        const driverPay = 130;

        let photoUrl = 'pending';

        // Upload photo to Supabase Storage
        console.log('Photo file:', photoFile);
        console.log('Photo file exists:', !!photoFile);
        
        if (photoFile) {
          console.log('Starting photo upload...');
          const fileExt = photoFile.name.split('.').pop();
          const fileName = `${currentDriver.id}_${Date.now()}.${fileExt}`;
          const filePath = `ticket-photos/${fileName}`;
          
          console.log('Upload path:', filePath);

          const { data: uploadData, error: uploadError } = await supabaseClient.storage
            .from('b5-trucking-photos')
            .upload(filePath, photoFile);

          console.log('Upload result:', { uploadData, uploadError });

          if (uploadError) {
            console.error('Photo upload error:', uploadError);
            // Continue without photo - don't block ticket submission
            photoUrl = 'upload-failed';
          } else {
            // Get public URL
            const { data: urlData } = supabaseClient.storage
              .from('b5-trucking-photos')
              .getPublicUrl(filePath);
            
            console.log('Public URL:', urlData);
            photoUrl = urlData.publicUrl;
          }
        } else {
          console.log('No photo file selected');
        }

        // Insert ticket into database
        const { data: newTicket, error } = await supabaseClient
          .from('tickets')
          .insert({
            driver_id: currentDriver.id,
            driver_name: actualDriverName,
            truck_number: truckNumber,
            ticket_number: ticketNumber,
            ticket_date: ticketDate,
            gross_weight: parseFloat(grossWeight),
            tare_weight: parseFloat(tareWeight),
            net_tons: netTons,
            route_notes: routeNotes,
            third_load: thirdLoad,
            photo_url: photoUrl,
            driver_pay: driverPay,
            bonus_pay: bonusPay
          })
          .select()
          .single();

        if (error) {
          throw error;
        }

        // Show success message
        const successMsg = document.getElementById('successMsg');
        successMsg.classList.add('show');
        setTimeout(() => {
          successMsg.classList.remove('show');
        }, 3000);

        // Clear form
        document.getElementById('truckNumber').value = '';
        document.getElementById('ticketNumber').value = '';
        document.getElementById('ticketDate').valueAsDate = new Date();
        document.getElementById('grossWeight').value = '';
        document.getElementById('tareWeight').value = '';
        document.getElementById('netTons').value = '';
        document.getElementById('routeNotes').value = '';
        document.getElementById('thirdLoad').value = 'No';
        document.getElementById('ticketPhoto').value = '';

        // Reload tickets
        await loadWeeklyTickets();
        
        // Reload chart data
        await loadAllDriverTickets();

      } catch (err) {
        console.error('Error submitting ticket:', err);
        alert('Error submitting ticket: ' + err.message);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Ticket';
      }
    }

    function updateTicketDisplay() {
      const tbody = document.getElementById('ticketBody');
      tbody.innerHTML = '';

      let totalLoadPay = 0;
      let totalBonusPay = 0;

      weeklyTickets.forEach((ticket, index) => {
        const row = tbody.insertRow();
        
        // Fix timezone issue - use the actual date from the database without conversion
        const ticketDate = ticket.ticket_date; // Already in YYYY-MM-DD format
        const displayDate = new Date(ticketDate + 'T00:00:00').toLocaleDateString();
        
        row.innerHTML = `
          <td>${index + 1}</td>
          <td>${displayDate}</td>
          <td>${ticket.ticket_number}</td>
          <td>${ticket.net_tons.toFixed(2)} tons</td>
          <td>${ticket.third_load ? '<span class="badge bonus">+$10</span>' : '-'}</td>
          <td style="text-align: right; font-weight: 600;">$${(ticket.driver_pay + ticket.bonus_pay).toFixed(2)}</td>
        `;

        totalLoadPay += ticket.driver_pay;
        totalBonusPay += ticket.bonus_pay;
      });

      document.getElementById('totalLoads').textContent = weeklyTickets.length;
      document.getElementById('loadPay').textContent = '$' + totalLoadPay.toFixed(2);
      document.getElementById('bonusPay').textContent = '$' + totalBonusPay.toFixed(2);
      document.getElementById('totalPay').textContent = '$' + (totalLoadPay + totalBonusPay).toFixed(2);

      if (weeklyTickets.length > 0) {
        document.getElementById('submittedSection').classList.remove('hidden');
      }
    }

    function updateStats() {
      let totalPay = 0;
      let totalBonus = 0;

      weeklyTickets.forEach(ticket => {
        totalPay += ticket.driver_pay;
        totalBonus += ticket.bonus_pay;
      });

      document.getElementById('weekLoadsCount').textContent = weeklyTickets.length;
      document.getElementById('weekEarnings').textContent = '$' + (totalPay + totalBonus).toLocaleString();
      document.getElementById('bonusEarnings').textContent = '$' + totalBonus.toLocaleString();
    }

    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        // Clear session
        localStorage.removeItem('b5_driver_session');
        
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('appContainer').classList.remove('active');
        document.getElementById('driverCode').value = '';
        currentDriver = null;
        weeklyTickets = [];
      }
    }

    // Allow Enter key to submit driver code
    document.addEventListener('DOMContentLoaded', function() {
      const codeInput = document.getElementById('driverCode');
      if (codeInput) {
        codeInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            submitCode();
          }
        });
      }

      // Check for existing session
      checkExistingSession();
    });

    // Driver Earnings Chart
    let driverChart = null;
    let allDriverTickets = [];

    // Toggle All Tickets Section
    function toggleAllTickets() {
      const section = document.getElementById('allTicketsSection');
      const btn = document.getElementById('toggleTicketsBtn');
      
      if (section.style.display === 'none') {
        section.style.display = 'block';
        btn.textContent = 'Hide';
        populateAllTickets();
      } else {
        section.style.display = 'none';
        btn.textContent = 'Show All';
      }
    }

    // Populate All Tickets Table
    function populateAllTickets(filteredTickets = null) {
      const tickets = filteredTickets || allDriverTickets;
      const tbody = document.getElementById('allTicketsBody');
      
      tbody.innerHTML = '';

      if (tickets.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: var(--text-muted);">No tickets found</td></tr>';
        document.getElementById('allTicketsCount').textContent = '0';
        document.getElementById('allTicketsLoadPay').textContent = '$0.00';
        document.getElementById('allTicketsBonusPay').textContent = '$0.00';
        document.getElementById('allTicketsTotal').textContent = '$0.00';
        return;
      }

      let totalLoadPay = 0;
      let totalBonusPay = 0;

      tickets.forEach(ticket => {
        const row = tbody.insertRow();
        
        // Fix timezone issue
        const ticketDate = ticket.ticket_date;
        const displayDate = new Date(ticketDate + 'T00:00:00').toLocaleDateString();
        
        row.innerHTML = `
          <td style="padding: 16px;">${displayDate}</td>
          <td style="padding: 16px;">${ticket.ticket_number}</td>
          <td style="padding: 16px;">${ticket.truck_number}</td>
          <td style="padding: 16px;">${ticket.gross_weight.toLocaleString()}</td>
          <td style="padding: 16px;">${ticket.tare_weight.toLocaleString()}</td>
          <td style="padding: 16px;">${ticket.net_tons.toFixed(2)}</td>
          <td style="padding: 16px;">${ticket.third_load ? '<span class="badge success">Yes (+$10)</span>' : '-'}</td>
          <td style="padding: 16px; text-align: right; font-weight: 600;">$${(ticket.driver_pay + ticket.bonus_pay).toFixed(2)}</td>
        `;

        totalLoadPay += ticket.driver_pay;
        totalBonusPay += ticket.bonus_pay;
      });

      document.getElementById('allTicketsCount').textContent = tickets.length;
      document.getElementById('allTicketsLoadPay').textContent = '$' + totalLoadPay.toFixed(2);
      document.getElementById('allTicketsBonusPay').textContent = '$' + totalBonusPay.toFixed(2);
      document.getElementById('allTicketsTotal').textContent = '$' + (totalLoadPay + totalBonusPay).toFixed(2);
    }

    // Filter All Tickets
    function filterAllTickets() {
      const year = document.getElementById('filterTicketYear').value;
      const month = document.getElementById('filterTicketMonth').value;
      const truck = document.getElementById('filterTicketTruck').value;

      let filtered = [...allDriverTickets];

      // Filter by year
      if (year !== 'all') {
        filtered = filtered.filter(t => {
          return new Date(t.ticket_date).getFullYear() === parseInt(year);
        });
      }

      // Filter by month
      if (month !== 'all') {
        filtered = filtered.filter(t => {
          return new Date(t.ticket_date).getMonth() + 1 === parseInt(month);
        });
      }

      // Filter by truck
      if (truck !== 'all') {
        filtered = filtered.filter(t => t.truck_number === truck);
      }

      populateAllTickets(filtered);
    }

    function initializeDriverChart(chartType = 'line') {
      const ctx = document.getElementById('driverEarningsChart');
      if (!ctx) return;

      const chartCtx = ctx.getContext('2d');
      
      const initialData = {
        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
        datasets: [{
          label: 'Earnings',
          data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
          borderColor: '#dc2626',
          backgroundColor: chartType === 'bar' ? 'rgba(220, 38, 38, 0.8)' : 'rgba(220, 38, 38, 0.1)',
          tension: 0.4,
          fill: true,
          borderWidth: chartType === 'bar' ? 0 : 3,
          pointBackgroundColor: '#dc2626',
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          pointRadius: chartType === 'bar' ? 0 : 5,
          pointHoverRadius: chartType === 'bar' ? 0 : 7
        }]
      };

      driverChart = new Chart(chartCtx, {
        type: chartType,
        data: initialData,
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { display: false },
            title: {
              display: true,
              text: '2025 - My Earnings',
              color: '#111827',
              font: { size: 16, weight: '600' },
              padding: { bottom: 20 }
            },
            tooltip: {
              backgroundColor: '#111827',
              padding: 12,
              displayColors: false,
              callbacks: {
                label: function(context) {
                  return '$' + context.parsed.y.toLocaleString();
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: { color: '#f3f4f6' },
              ticks: {
                callback: function(value) {
                  return '$' + value;
                },
                color: '#6b7280'
              }
            },
            x: {
              grid: { display: false },
              ticks: { color: '#6b7280' }
            }
          }
        }
      });
    }

    async function loadAllDriverTickets() {
      if (!currentDriver) return;

      try {
        const { data: tickets, error } = await supabaseClient
          .from('tickets')
          .select('*')
          .eq('driver_id', currentDriver.id)
          .order('ticket_date', { ascending: true });

        if (error) throw error;
        allDriverTickets = tickets || [];

        // Initialize and update chart
        if (!driverChart) {
          initializeDriverChart();
        }
        updateDriverChart();

      } catch (err) {
        console.error('Error loading driver tickets:', err);
      }
    }

    function updateDriverChart() {
      if (!driverChart || !currentDriver) return;

      const year = parseInt(document.getElementById('driverChartYear').value);
      const view = document.getElementById('driverChartView').value;
      const month = document.getElementById('driverChartMonth').value;

      // Filter tickets by year
      let filteredTickets = allDriverTickets.filter(t => {
        const ticketDate = new Date(t.ticket_date);
        return ticketDate.getFullYear() === year;
      });

      let labels, data, chartType = 'line';
      
      if (view === 'monthly') {
        if (month !== 'all') {
          // Daily data for specific month
          const selectedMonth = parseInt(month);
          const daysInMonth = new Date(year, selectedMonth, 0).getDate();
          labels = Array.from({length: daysInMonth}, (_, i) => (i + 1).toString());
          data = new Array(daysInMonth).fill(0);

          filteredTickets.forEach(t => {
            const ticketDate = new Date(t.ticket_date);
            if (ticketDate.getMonth() + 1 === selectedMonth) {
              const day = ticketDate.getDate() - 1;
              data[day] += (t.driver_pay + t.bonus_pay);
            }
          });

          const monthNames = ['', 'January', 'February', 'March', 'April', 'May', 'June', 
                            'July', 'August', 'September', 'October', 'November', 'December'];
          driverChart.options.plugins.title.text = monthNames[selectedMonth] + ' ' + year + ' - Daily Earnings';
        } else {
          // Monthly data for full year
          labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
          data = new Array(12).fill(0);
          
          filteredTickets.forEach(t => {
            const monthIndex = new Date(t.ticket_date).getMonth();
            data[monthIndex] += (t.driver_pay + t.bonus_pay);
          });

          driverChart.options.plugins.title.text = year + ' - Monthly Earnings';
        }
      } else if (view === 'weekly') {
        // Last 8 weeks
        labels = [];
        data = new Array(8).fill(0);
        const now = new Date();
        
        for (let i = 7; i >= 0; i--) {
          const weekStart = new Date(now);
          weekStart.setDate(now.getDate() - (i * 7));
          const weekEnd = new Date(weekStart);
          weekEnd.setDate(weekStart.getDate() + 6);
          
          labels.push(`Week ${8 - i}`);
          
          allDriverTickets.forEach(t => {
            const ticketDate = new Date(t.ticket_date);
            if (ticketDate >= weekStart && ticketDate <= weekEnd) {
              data[7 - i] += (t.driver_pay + t.bonus_pay);
            }
          });
        }
        
        driverChart.options.plugins.title.text = 'Last 8 Weeks - Earnings';
      } else if (view === 'quarter') {
        labels = ['Q1', 'Q2', 'Q3', 'Q4'];
        data = [0, 0, 0, 0];
        chartType = 'bar';
        
        filteredTickets.forEach(t => {
          const monthIndex = new Date(t.ticket_date).getMonth();
          const quarter = Math.floor(monthIndex / 3);
          data[quarter] += (t.driver_pay + t.bonus_pay);
        });

        driverChart.options.plugins.title.text = year + ' - Quarterly Earnings';
      }

      // Update chart type if needed
      if (driverChart.config.type !== chartType) {
        driverChart.destroy();
        initializeDriverChart(chartType);
        return updateDriverChart(); // Recursive call with new chart
      }

      // Update chart data
      driverChart.data.labels = labels;
      driverChart.data.datasets[0].data = data;
      
      // Update styling
      if (chartType === 'bar') {
        driverChart.data.datasets[0].backgroundColor = 'rgba(220, 38, 38, 0.8)';
        driverChart.data.datasets[0].borderWidth = 0;
      } else {
        driverChart.data.datasets[0].backgroundColor = 'rgba(220, 38, 38, 0.1)';
        driverChart.data.datasets[0].borderWidth = 3;
      }
      
      driverChart.update();

      // Update summary stats
      const total = data.reduce((a, b) => a + b, 0);
      const loads = filteredTickets.length;
      document.getElementById('driverTotalEarnings').textContent = '$' + total.toLocaleString();
      document.getElementById('driverTotalLoads').textContent = loads;
      document.getElementById('driverAvgPerLoad').textContent = loads > 0 ? '$' + Math.round(total / loads) : '$0';
    }

    function handleDriverViewChange() {
      const view = document.getElementById('driverChartView').value;
      const monthFilter = document.getElementById('driverMonthFilter');
      
      if (view === 'monthly') {
        monthFilter.style.display = 'block';
      } else {
        monthFilter.style.display = 'none';
        document.getElementById('driverChartMonth').value = 'all';
      }
      
      updateDriverChart();
    }

    // Check if user is already logged in
    async function checkExistingSession() {
      const session = localStorage.getItem('b5_driver_session');
      
      if (session) {
        try {
          const { driver, loginTime } = JSON.parse(session);
          
          // Check if session is less than 7 days old
          const sessionAge = new Date() - new Date(loginTime);
          const sevenDays = 7 * 24 * 60 * 60 * 1000;
          
          if (sessionAge < sevenDays) {
            // Verify driver still exists and is active
            const { data: verifiedDriver, error } = await supabaseClient
              .from('drivers')
              .select('*')
              .eq('id', driver.id)
              .eq('status', 'active')
              .single();

            if (!error && verifiedDriver) {
              // Auto-login
              currentDriver = verifiedDriver;
              document.getElementById('driverName').value = verifiedDriver.name;
              document.getElementById('driverBadge').textContent = verifiedDriver.name;

              if (verifiedDriver.driver_code === '00') {
                document.getElementById('otherNameSection').classList.remove('hidden');
              }

              document.getElementById('loginScreen').style.display = 'none';
              document.getElementById('appContainer').classList.add('active');
              document.getElementById('ticketDate').valueAsDate = new Date();

              await loadWeeklyTickets();
              await loadAllDriverTickets();
            } else {
              // Session invalid - clear it
              localStorage.removeItem('b5_driver_session');
            }
          } else {
            // Session expired - clear it
            localStorage.removeItem('b5_driver_session');
          }
        } catch (err) {
          console.error('Session restore error:', err);
          localStorage.removeItem('b5_driver_session');
        }
      }
    }
  </script>
</body>
</html>
